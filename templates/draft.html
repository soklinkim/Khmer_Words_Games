<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8">
  <title>Word Learning</title>
  <style>
    body {
      font-family: "Noto Sans Khmer", sans-serif;
      background: #f0f0f0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
  
  .container {
      text-align: center;
      background: white;
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      width: 80%;
      margin-top: 20px;
  }
  
  /* Image row */
  #image-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-bottom: 20px;
      flex-wrap: nowrap;
  }
  .word-image {
      width: ;
      height: auto;
  }
  .image-box {
      width: auto;
      height: auto;
      border-radius: 12px;
      object-fit: cover;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s;
      cursor: pointer;
  }
  
  .image-box:hover {
      transform: scale(1.05);
  }
  
  .drop-row {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
  }
    
  .drop-box {
      width: 150px;
      height: 50px;
      border: 2px dashed #333;
      border-radius: 8px;
      background-color: #fff8f8;
      font-size: 24px;
      font-weight: bold;
      color: #555;
      display: flex;
      align-items: center;
      justify-content: center;
  }
    
  
  .drag-row {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    
    .draggable {
      width: 120px;
      height: 50px;
      background-color: #e1f5fe;
      border: 1px solid #81d4fa;
      border-radius: 8px;
      cursor: grab;
      font-weight: bold;
      font-size: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
  }
    
  
  /* Result feedback */
  #result {
      font-size: 22px;
      font-weight: bold;
      color: #d32f2f;
      margin-top: 10px;
  }
  #image-row {
      display: flex;
      justify-content: space-around; /* or use space-between / center */
      align-items: center;
      gap: 1rem; /* Optional: adds spacing between images */
      margin-bottom: 20px;
      flex-wrap: nowrap; /* Ensure images stay in one row */
    }
    
  .learning-image {
      width: 100px; /* Or adjust as needed */
      height: auto;
      cursor: pointer;
  }
  .word-image {
      width: auto;
      height: auto;
  }  
  </style>
</head>
<body>
  <div class="container">
    <button onclick="location.href='/'">⬅ ត្រឡប់ក្រោយ</button>
    <h1>📚 រៀនពាក្យ</h1>

    <!-- Row for dynamically loaded images -->
    <div id="image-row">
      <img class="word-image" src="" alt="Word Image">
      <audio id="audio" src=""></audio>
    </div>

    <!-- Drop row with correct class names -->
    <div class="drop-row" id="drop-row">
      <div class="drop-box" data-part="first"></div>
      <div class="drop-box" data-part="second"></div>
      <div class="drop-box" data-part="third"></div>
    </div>

    <!-- Drag row with correct class names -->
    <div class="drag-row" id="drag-row">
      <div class="draggable" draggable="true">ក</div>
      <div class="draggable" draggable="true">្ម</div>
      <div class="draggable" draggable="true">រ</div>
    </div>


    <!-- Action buttons -->
    <button onclick="checkAnswer()">✅ ពិនិត្យ</button>
    <button onclick="resetLearningMode()">🔁 កំណត់ឡើងវិញ</button>

    <!-- Result message -->
    <div id="learning-result"></div>
  </div>

  <!-- Your main JS -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      loadLearningSet();
      document.getElementById('next-button').addEventListener('click', loadLearningSet);
  });
  
  let correctAnswers = [];
  let audioMap = {};
  
  function resetLearningMode() {
      // Clear drop boxes
      document.querySelectorAll('.drop-box').forEach(box => box.textContent = '');
  
      // Show all hidden draggable items
      document.querySelectorAll('.draggable').forEach(item => {
          item.style.visibility = 'visible';
      });
  
      // Clear result message
      document.getElementById('learning-result').textContent = '';
  }
  
  function clearInterface() {
      document.getElementById('image-row').innerHTML = '';
      document.getElementById('drop-row').innerHTML = '';
      document.getElementById('drag-row').innerHTML = '';
      document.getElementById('learning-result').textContent = '';
  }
  
  function loadLearningSet() {
      fetch('/learning-mode')
          .then(res => res.json())
          .then(data => {
              clearInterface();
              correctAnswers = data.words.map(w => w.word);
              audioMap = {};
  
              const imageRow = document.getElementById('image-row');
              const dropRow = document.getElementById('drop-row');
              const dragRow = document.getElementById('drag-row');
              data.words.forEach((w, idx) => {
                  // Create container div for image and audio
                  const imageBox = document.createElement('div');
                  imageBox.className = 'image-box';
              
                  const img = document.createElement('img');
                  img.src = w.img_path;
                  img.className = 'learning-image';
              
                  const audio = new Audio(w.audio_path);
                  img.addEventListener('click', () => {
                      audio.play();
                  });
              
                  imageBox.appendChild(img);
                  imageRow.appendChild(imageBox);
              
                  // Create matching drop box
                  const drop = document.createElement('div');
                  drop.className = 'drop-box';
                  drop.dataset.index = idx;
                  drop.ondragover = e => e.preventDefault();
                  drop.ondrop = e => {
                      e.preventDefault();
                      const text = e.dataTransfer.getData("text/plain");
                      drop.textContent = text;
                      drop.dataset.user = text;
                      document.querySelectorAll('.draggable').forEach(d => {
                          if (d.textContent === text) d.style.visibility = 'hidden';
                      });
                  };
                  drop.addEventListener('click', () => {
                      const text = drop.textContent;
                      drop.textContent = '';
                      delete drop.dataset.user;
                      drop.style.backgroundColor = '';
                      drop.style.borderColor = '';
                      document.querySelectorAll('.draggable').forEach(d => {
                          if (d.textContent === text) d.style.visibility = 'visible';
                      });
                  });
                  dropRow.appendChild(drop);
              });         
  
              // Draggable choices
              data.choices.forEach(word => {
                  const drag = document.createElement('div');
                  drag.className = 'draggable';
                  drag.textContent = word;
                  drag.draggable = true;
  
                  drag.addEventListener('dragstart', e => {
                      e.dataTransfer.setData("text/plain", drag.textContent);
                  });
  
                  dragRow.appendChild(drag);
              });
          });
  }
  
  function checkLearningAnswer() {
      const boxes = document.querySelectorAll('.drop-box');
      let incorrect = 0;
  
      boxes.forEach((box, idx) => {
          const correct = box.dataset.correct;
          const user = box.dataset.user;
  
          if (user === correct) {
              box.style.borderColor = 'green';
              box.style.borderWidth = '3px';
              audioMap[correct]?.play();
          } else {
              box.style.borderColor = 'red';
              box.style.borderWidth = '3px';
              incorrect++;
          }
      });
  
      const result = document.getElementById('learning-result');
      if (incorrect === 0) {
          result.textContent = '✅ ត្រឹមត្រូវទាំងអស់!';
          result.style.color = 'green';
      } else {
          result.textContent = `❌ ខុស ${incorrect} ប្រភេទ`;
          result.style.color = 'red';
      }
  }
  
  </script>
</body>
</html>