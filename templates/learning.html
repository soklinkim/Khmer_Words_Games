<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8">
  <title>Word Learning</title>
  <style>
    body {
      font-family: "Noto Sans Khmer", sans-serif;
      background: #f0f0f0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .container {
      text-align: center;
      background: white;
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      width: 80%;
      margin-top: 20px;
    }

    /* Row Styles */
    .row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .image-box:hover {
      transform: scale(1.05);
    }

    .learning-image {
      width: 200px;
      height: auto;
      cursor: pointer;
    }

    .drop-box {
      width: 150px;
      height: 50px;
      border: 2px dashed #333;
      border-radius: 8px;
      background-color: #fff8f8;
      font-size: 24px;
      font-weight: bold;
      color: #555;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .draggable {
      width: 120px;
      height: 50px;
      background-color: #e1f5fe;
      border: 1px solid #81d4fa;
      border-radius: 8px;
      cursor: grab;
      font-weight: bold;
      font-size: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
    }

    #learning-result {
      font-size: 22px;
      font-weight: bold;
      margin-top: 10px;
    }
    button {
      font-family: "Noto Sans Khmer", sans-serif;
      font-size: 20px;
      margin-top: 15px;
      font-weight: bold;
    }

  </style>
</head>
<body>
  <div class="container">
    <button onclick="location.href='/'">‚¨Ö ·ûè·üí·ûö·û°·ûî·üã·ûÄ·üí·ûö·üÑ·ûô</button>
    <h1>üìö ·ûö·üÄ·ûì·ûñ·û∂·ûÄ·üí·ûô</h1>

    <!-- First Row: Images -->
    <div id="image-row" class="row" ></div>

    <!-- Second Row: Drop Boxes -->
    <div id="drop-row" class="row"></div>

    <!-- Third Row: Draggable Items -->
    <div id="drag-row" class="row"></div>

    <!-- Action buttons -->
    <button onclick="checkLearningAnswer()">‚úÖ ·ûñ·û∑·ûì·û∑·ûè·üí·ûô</button>

    <!-- Result message -->
    <div id="learning-result"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      loadLearningSet();
    });

    let correctAnswers = [];
    let audioMap = {};

    function clearInterface() {
      document.getElementById('image-row').innerHTML = '';
      document.getElementById('drop-row').innerHTML = '';
      document.getElementById('drag-row').innerHTML = '';
      document.getElementById('learning-result').textContent = '';
    }

    function loadLearningSet() {
      fetch('/learning-mode')
        .then(res => res.json())
        .then(data => {
          clearInterface();
          correctAnswers = data.words.map(w => w.word);
          audioMap = {};

          const imageRow = document.getElementById('image-row');
          const dropRow = document.getElementById('drop-row');
          const dragRow = document.getElementById('drag-row');

          // Limit to 2 words
          data.words.slice(0, 2).forEach((w, idx) => {
            const imageBox = document.createElement('div');
            imageBox.className = 'image-box';

            const img = document.createElement('img');
            img.src = w.img_path;
            img.className = 'learning-image';

            const audio = new Audio(w.audio_path);
            img.addEventListener('click', () => {
              audio.play();
            });

            audioMap[w.word] = audio;
            imageBox.appendChild(img);
            imageRow.appendChild(imageBox);

            // Drop box for this word
            const drop = document.createElement('div');
            drop.className = 'drop-box';
            drop.dataset.correct = w.word;

            drop.ondragover = e => e.preventDefault();
            drop.ondrop = e => {
              e.preventDefault();
              const text = e.dataTransfer.getData("text/plain");
              drop.textContent = text;
              drop.dataset.user = text;
              document.querySelectorAll('.draggable').forEach(d => {
                if (d.textContent === text) d.style.visibility = 'hidden';
              });
            };

            drop.addEventListener('click', () => {
              const text = drop.textContent;
              drop.textContent = '';
              delete drop.dataset.user;
              drop.style.borderColor = '';
              document.querySelectorAll('.draggable').forEach(d => {
                if (d.textContent === text) d.style.visibility = 'visible';
              });
            });

            dropRow.appendChild(drop);
          });

                  // Ensure correct answers are included
        const correctWords = data.words.slice(0, 2).map(w => w.word);
        const allChoices = new Set(correctWords);

        // Randomly add more distractors (wrong choices) until we have 4 total
        while (allChoices.size < 4 && data.choices.length > allChoices.size) {
          const randomChoice = data.choices[Math.floor(Math.random() * data.choices.length)];
          allChoices.add(randomChoice);
        }

        // Shuffle the final list
        const finalChoices = Array.from(allChoices).sort(() => Math.random() - 0.5);

        // Create draggable elements
        finalChoices.forEach(word => {
          const drag = document.createElement('div');
          drag.className = 'draggable';
          drag.textContent = word;
          drag.draggable = true;

          drag.addEventListener('dragstart', e => {
            e.dataTransfer.setData("text/plain", drag.textContent);
          });

          dragRow.appendChild(drag);
        });

        });
    }

    function checkLearningAnswer() {
      const boxes = document.querySelectorAll('.drop-box');
      let incorrect = 0;
    
      boxes.forEach(box => {
        const correct = box.dataset.correct;
        const user = box.dataset.user;
    
        if (user === correct) {
          box.style.borderColor = 'green';
          box.style.borderWidth = '3px';
        } else {
          box.style.borderColor = 'red';
          box.style.borderWidth = '3px';
          incorrect++;
        }
      });
    
      const result = document.getElementById('learning-result');
      if (incorrect === 0) {
        result.textContent = '‚úÖ ·ûè·üí·ûö·ûπ·ûò·ûè·üí·ûö·ûº·ûú!';
        result.style.color = 'green';
    
        setTimeout(() => {
          loadLearningSet();
        }, 1500); // delay before showing next pair
      } else {
        result.textContent = `‚ùå ·ûÅ·ûª·ûü ${incorrect}`;
        result.style.color = 'red';
      }
    }
    function playAudio(path) {
      const audio = new Audio(path);
      audio.play();
  }
  
  // Example: when user clicks a word
  document.querySelectorAll('.word-button').forEach(btn => {
      btn.addEventListener('click', function() {
          const audioPath = this.getAttribute('data-audio');
          playAudio(audioPath);
      });
  });
  
  </script>
</body>
</html>
